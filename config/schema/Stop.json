{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mindnext.dev/schema/Stop.json",
  "title": "Stop Hook API",
  "description": "Claude 結束響應前事件的完整 API 定義。無權限控制，僅支援 decision/reason 和通用輸出欄位",
  "x-notes": "Stop 事件輸出在頂層（非 hookSpecificOutput），包含 decision 和通用系統控制欄位",
  "examples": {
    "event_example": {
      "hook_event_name": "Stop",
      "session_id": "abc-123",
      "transcript_path": "/home/user/.claude/transcripts/xyz.jsonl",
      "cwd": "/home/user/project",
      "permission_mode": "default",
      "stop_hook_active": true
    },
    "response_block_example": {
      "description": "阻止停止的響應",
      "output": {
        "decision": "block",
        "reason": "需要進一步確認",
        "continue": false,
        "systemMessage": "響應處理中，請稍候"
      }
    },
    "response_allow_with_context_example": {
      "description": "允許停止並注入額外上下文",
      "output": {
        "continue": true,
        "hookSpecificOutput": {
          "hookEventName": "Stop",
          "additionalContext": "已記錄用戶會話數據"
        }
      }
    },
    "response_suppress_example": {
      "description": "允許停止但抑制輸出",
      "output": {
        "suppressOutput": true,
        "systemMessage": "內部系統訊息"
      }
    }
  },
  "definitions": {
    "event": {
      "title": "Stop Event Input",
      "description": "從 Claude Code stdin 接收的 payload。Stop 事件在 Claude 結束響應前觸發，可用於決策或檢查",
      "x-usage": "檢查是否應阻止響應、驗證狀態、記錄日誌",
      "x-canBlock": true,
      "x-canTransform": false,
      "type": "object",
      "required": [
        "cwd",
        "stop_hook_active",
        "transcript_path",
        "hook_event_name",
        "session_id",
        "permission_mode"
      ],
      "properties": {
        "hook_event_name": {
          "type": "string",
          "const": "Stop",
          "description": "事件名稱，固定為 'Stop'"
        },
        "session_id": {
          "type": "string",
          "description": "當前會話 ID"
        },
        "transcript_path": {
          "type": "string",
          "description": "完整對話記錄文件路徑"
        },
        "cwd": {
          "type": "string",
          "description": "當前工作目錄"
        },
        "stop_hook_active": {
          "type": "boolean",
          "description": "Stop hook 是否啟用（Stop 事件特有欄位）"
        },
        "permission_mode": {
          "type": "string",
          "enum": [
            "default",
            "plan",
            "acceptEdits",
            "dontAsk",
            "bypassPermissions"
          ],
          "description": "權限模式"
        }
      },
      "additionalProperties": false
    },
    "response": {
      "title": "Stop Response Output",
      "description": "輸出到 Claude Code stdout 的 JSON。Stop 事件輸出在頂層（非 hookSpecificOutput），無 hookSpecificOutput 結構",
      "x-note": "Stop 輸出不使用 hookSpecificOutput，decision 和 reason 在頂層；通用欄位可用於系統控制",
      "type": "object",
      "properties": {
        "decision": {
          "type": "string",
          "enum": [
            "block"
          ],
          "description": "決策：block 表示阻止停止（不輸出無 decision 視為允許）"
        },
        "reason": {
          "type": "string",
          "description": "決策原因，block 時建議填充"
        },
        "continue": {
          "type": "boolean",
          "default": true,
          "description": "是否繼續執行（通用欄位）"
        },
        "stopReason": {
          "type": "string",
          "description": "停止原因文字，當 continue=false 時使用（通用欄位）"
        },
        "suppressOutput": {
          "type": "boolean",
          "default": false,
          "description": "是否抑制輸出（通用欄位）"
        },
        "systemMessage": {
          "type": "string",
          "description": "系統內部訊息（通用欄位）"
        }
      },
      "additionalProperties": false
    },
    "rule": {
      "title": "Stop Rule Config",
      "description": "config/rules/*.md 中的 YAML frontmatter 配置",
      "type": "object",
      "required": [
        "name",
        "description",
        "enabled",
        "event"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Rule 唯一名稱"
        },
        "description": {
          "type": "string",
          "description": "Rule 說明"
        },
        "enabled": {
          "type": "boolean",
          "description": "是否啟用此 rule"
        },
        "event": {
          "type": "string",
          "const": "Stop",
          "description": "事件類型，必須為 'Stop'"
        },
        "priority": {
          "type": "integer",
          "default": 50,
          "description": "執行優先級（數字越大優先級越高）"
        },
        "action": {
          "type": "string",
          "enum": [
            "block"
          ],
          "description": "動作：block 表示阻止停止"
        },
        "reason": {
          "type": "string",
          "description": "action 的原因"
        },
        "additionalContext": {
          "type": "string",
          "description": "注入額外上下文到 Claude（可選）"
        }
      },
      "additionalProperties": false
    }
  },
  "oneOf": [
    {
      "$ref": "#/definitions/event"
    },
    {
      "$ref": "#/definitions/response"
    },
    {
      "$ref": "#/definitions/rule"
    }
  ]
}
